<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salas - O Teólogo</title>
  <meta name="description" content="Explore as salas de debate disponíveis em O Teólogo. Junte-se a discussões sobre Escatologia, Trindade, Cristologia e muitos outros temas teológicos.">
  <link rel="stylesheet" href="styles.css?v=1" />
  <style>
    /* Estilos específicos para esta página, para complementar o styles.css */
    /* Estes estilos farão com que o 'main' atue como o grande 'card' central */
    main {
      max-width: 540px; /* Largura para o cartão central, como no cadastro.html */
      margin: 3rem auto; /* Centraliza o cartão e dá espaçamento superior */
      padding: 2rem 1.5rem; /* Preenchimento interno do cartão */
      background: #fff; /* Fundo branco para o cartão */
      border-radius: 14px; /* Bordas arredondadas */
      box-shadow: 0 4px 24px rgba(0,0,0,0.09); /* Sombra para o efeito de elevação */
      text-align: center; /* Centraliza o texto e elementos dentro deste main */
    }

    /* Ajustes para elementos dentro do main/card */
    main h2 {
      font-size: 1.75rem;
      margin-bottom: 2.5rem; /* Mais espaço abaixo do título principal */
      color: #222; /* Cor mais escura, como na imagem */
      border-bottom: none; /* Remove a linha azul de h2 que é comum em seções */
      padding-bottom: 0;
    }

    /* Estilo para os blocos de seleção de sala (substituindo .card e .sala) */
    .sala-bloco {
      margin-bottom: 2rem; /* Espaçamento entre os blocos de seleção */
      padding: 0.5rem 0; /* Ajuste de padding para não criar borda dupla se fosse .sala */
      text-align: center; /* Garante que o conteúdo de cada bloco esteja centralizado */
    }

    .sala-bloco h3 { /* Para os títulos como "Salas Disponíveis:" e "Salas Criadas por Usuários:" */
      font-size: 1.05rem;
      font-weight: bold;
      color: #003366; /* Cor azul do tema */
      margin-top: 0;
      margin-bottom: 0.75rem; /* Espaço abaixo do subtítulo */
    }

    .sala-bloco select {
      padding: 0.5rem; /* Ajusta o padding para ser igual aos inputs do styles.css */
      font-size: 1rem; /* Ajusta o tamanho da fonte */
      border-radius: 6px; /* Bordas arredondadas */
      border: 1px solid #ccc; /* Borda padrão */
      width: 90%; /* Ocupa 90% da largura do contêiner */
      max-width: 420px; /* Limita a largura máxima */
      margin-bottom: 1rem; /* Espaço abaixo do select */
      box-sizing: border-box; /* Inclui padding e border na largura */
      display: block; /* Para que margin: auto funcione */
      margin-left: auto; /* Centraliza o select */
      margin-right: auto; /* Centraliza o select */
    }

    .sala-bloco button {
      padding: 0.45rem 1.4rem; /* Ajusta o padding para ser mais enxuto, como na imagem */
      font-size: 1rem; /* Ajusta o tamanho da fonte */
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin: 0.2rem 0.4rem; /* Espaçamento entre botões */
      transition: all 0.3s ease; /* Transição suave no hover */
    }

    /* Mantém os estilos de cores dos botões do styles.css */
    .btn {
      background-color: #007bff;
      color: white;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    .btn.green {
      background-color: #28a745;
    }
    .btn.green:hover {
      background-color: #1e7e34;
    }

    /* Remover a seção 'hero' que foi adicionada antes, pois o novo main é o 'hero' aqui */
    .hero { /* Apenas para garantir que o hero específico da página de salas não interfira */
      display: none;
    }
  </style>
</head>
<body>
<div class="top-bar">
  <a href="/apoie.html" style="color:white;">APOIE O PROJETO E GANHE UM PRESENTE!</a>
</div>
<div class="header-logo">
  <div class="logo">O Teólogo</div>
</div>

<nav class="menu">
  <a href="/">Início</a>
  <a href="/salas">Salas Disponíveis</a>
  <a href="/criar">Criar Nova Sala</a>
  <a href="/auth">Login/Logout</a>
  <a href="/apoie.html">App Mobile</a>
  <a href="/estudos/estudos-teologicos.html">Estudos Teológicos</a>
  <span id="userStatus">Logado como: <span id="apelido"></span></span>
</nav>

<main>
  <h2>Salas Disponíveis</h2>

  <div class="sala-bloco">
    <h3>Salas Disponíveis:</h3>
    <select id="selectSalasFixas">
    </select><br />
    <button class="btn" onclick="entrarSalaSelecionada('fixa')">Entrar</button>
  </div>

  <div class="sala-bloco">
    <h3>Salas Criadas por Usuários:</h3>
    <select id="selectSalasUsuario">
      <option>Nenhuma sala criada por usuários ainda.</option>
    </select><br />
    <button class="btn" onclick="entrarSalaSelecionada('usuario')">Entrar</button>
    <button class="btn green" onclick="window.location.href='/criar.html'">Criar</button>
  </div>
</main>

<footer>
  © 2025 O Teólogo. Todos os direitos reservados. |
  <a href="/faleconosco.html" style="color:inherit;">Fale Conosco</a>
</footer>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const apelido = localStorage.getItem('apelido');
  const token = localStorage.getItem('token');
  if (apelido) document.getElementById('apelido').textContent = apelido;

  const salasFixas = [
    'Escatologia','Trindade','Livre Arbítrio','Soteriologia','Bibliologia',
    'Cristologia','Ateus','Católicos','Pentecostais','Adventistas',
    'Presbiterianos','Batistas','Testemunhas da Jeova','Mórmons'
  ];

  socket.on("usuariosNaSala", (mapaDeSalas) => {
    const select = document.getElementById("selectSalasFixas");
    select.innerHTML = '';
    for (const nomeSala of salasFixas) {
      const total = mapaDeSalas[nomeSala]?.length || 0;
      const option = document.createElement('option');
      option.value = nomeSala;
      option.textContent = `${nomeSala} (${total} participante${total === 1 ? '' : 's'})`;
      select.appendChild(option);
    }
  });

  async function atualizarSalasUsuario() {
    const select = document.getElementById('selectSalasUsuario');
    select.innerHTML = '';
    try {
      const res = await fetch('/api/salas/usuario');
      const salasUsuario = await res.json();
      if (salasUsuario.length === 0) {
        const option = document.createElement('option');
        option.disabled = true; option.selected = true;
        option.textContent = "Nenhuma sala criada por usuários ainda.";
        select.appendChild(option);
      } else {
        for (const sala of salasUsuario) {
          const option = document.createElement('option');
          option.value = sala.nome;
          option.textContent = `${sala.nome}, (${sala.total} participante${sala.total === 1 ? '' : 's'})`;
          select.appendChild(option);
        }
      }
    } catch (err) {
      console.error("Erro ao buscar salas de usuários:", err);
      const option = document.createElement('option');
      option.disabled = true; option.selected = true;
      option.textContent = "Erro ao buscar salas de usuários.";
      select.appendChild(option);
    }
  }

  async function entrarSalaSelecionada(tipo) {
    const select = tipo === 'fixa' ? document.getElementById('selectSalasFixas') : document.getElementById('selectSalasUsuario');
    const nomeSala = select.value;
    if (!nomeSala || !token || !apelido) {
      alert("Você precisa estar logado para entrar em uma sala. Por favor, faça login.");
      window.location.href = '/auth.html';
      return;
    }
    const apiUrl = tipo === 'usuario'
            ? `/api/salas/usuario/${encodeURIComponent(nomeSala)}/entrar`
            : `/api/salas/${encodeURIComponent(nomeSala)}/entrar`;

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({})
      });

      if (res.ok) {
        localStorage.setItem('sala', nomeSala);
        window.location.href = `/chat?sala=${encodeURIComponent(nomeSala)}&usuario=${encodeURIComponent(apelido)}`;
      } else {
        const errorData = await res.json();
        alert(`Não foi possível entrar na sala: ${errorData.msg || 'Erro desconhecido.'}`);
      }
    } catch (err) {
      console.error('Erro na requisição para entrar na sala:', err);
      alert('Ocorreu um erro ao tentar entrar na sala. Tente novamente.');
    }
  }

  atualizarSalasUsuario();
  setInterval(atualizarSalasUsuario, 30000);

  document.addEventListener('DOMContentLoaded', () => {
    const apelidoStorage = localStorage.getItem('apelido');
    if (apelidoStorage) {
      document.getElementById('apelido').textContent = apelidoStorage;
    } else {
      document.getElementById('userStatus').textContent = 'Não Logado';
    }
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4TV9KF3766"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4TV9KF3766');
</script>
</body>
</html>